#!/usr/bin/env ruby
# frozen_string_literal: true

require 'pwn'

opts = PWN::Env[:driver_opts]
OptionParser.new do |options|
  options.banner = "USAGE:
    #{File.basename($PROGRAM_NAME)} [opts]
  "

  options.on('-YPATH', '--pwn-env=PATH', '<Optional - PWN YAML File>') do |p|
    opts[:pwn_env_path] = p
  end

  options.on('-ZPATH', '--pwn-dec=PATH', '<Optional - Out-of-Band YAML File with :key && :iv>') do |d|
    opts[:pwn_dec_path] = d
  end
end.parse!

begin
  pwn_pid = Process.pid
  PWN::Plugins::REPL.start(opts)
rescue StandardError => e
  raise e
ensure
  ps_list_arr = PWN::Plugins::PS.list

  kid_pids_arr = ps_list_arr.select { |ps_line| ps_line[3] == pwn_pid.to_s }
  # pp kid_pids_arr

  grandkid_pids_arr = []
  kid_pids_arr.each do |kid_pid|
    gk_arr = ps_list_arr.select { |ps_line| ps_line[3] == kid_pid[2] }
    gk_arr.each { |gk| grandkid_pids_arr.push(gk) }
  end
  # pp grandkid_pids_arr

  PWN::Plugins::PS.cleanup_pids(pids_arr: grandkid_pids_arr)
  PWN::Plugins::PS.cleanup_pids(pids_arr: kid_pids_arr)
end
