#!/usr/bin/env ruby
# frozen_string_literal: true

require 'pwn'

opts = PWN::Env[:driver_opts]
PWN::Driver::Parser.new do |options|
  options.on('-aPROFILE', '--assume-profile=PROFILE', '<Required if "--target-freq" is Nil - Profile to assume for common radio protocols.  Use "--list-scan-profiles" to display supported protocols (Defaults to nil)') do |p|
    opts[:profile] = p
  end

  options.on('-l', '--list-scan-profiles', '<Optional - List supported scan profiles and exit>') do |l|
    opts[:list_scan_profiles] = l
  end

  options.on('-sFREQ', '--start-freq=FREQ', '<Required if "--assume-profile" is Nil - Frequency to Start Scanning (e.g. 800.000.000 == 800 mHz>') do |s|
    opts[:start_freq] = s
  end

  options.on('-tFREQ', '--target-freq=FREQ', '<Required if "--assume-profile" is Nil - Frequency to Conclude Scanning (e.g. 900.000.000 == 900 mHz>') do |e|
    opts[:target_freq] = e
  end

  options.on('-hHOST', '--host=HOST', '<Optional - GQRX Host (Defaults to 127.0.0.1)>') do |h|
    opts[:host] = h
  end

  options.on('-pPORT', '--port=PORT', '<Optional - GQRX Port (Defaults to 7356)>') do |p|
    opts[:port] = p
  end

  options.on('-AFLOAT', '--audio-gain=FLOAT', '<Optional - Set audio gain -80.0 to 50.0 (Defaults to 9.0)>') do |a|
    opts[:audio_gain_db] = a
  end

  options.on('-bHZ', '--bandwidth=HZ', '<Optional - Set Bandwidth 0.0 - SDR Bandwidth Limit, e.g. 20.000.000 (Defaults to 270.000)>') do |b|
    opts[:bandwidth] = b
  end

  options.on('-DMODE', '--demodulator-mode=MODE', '<Optional - Set Demodulator Mode OFF | RAW | AM | FM | WFM | WFM_ST | WFM_ST_OIRT | LSB | USB | CW | CWL | CWU (Defaults to WFM_ST)>') do |d|
    opts[:demodulator_mode] = d
  end

  options.on('-PINT', '--precision=INT', '<Optional - Precision of Frequency 1-12 (Defaults to 5)>') do |p|
    opts[:precision] = p
  end

  options.on('-SFLOAT', '--strength-lock=FLOAT', '<Optional - Strength to lock onto frequency (Defaults to -70.0)>') do |s|
    opts[:strength_lock] = s
  end

  options.on('-QFLOAT', '--squelch=FLOAT', '<Optional - Squelch Threshold -150.0 to 0 (Defaults to --strength-lock - 3)>') do |q|
    opts[:squelch] = q
  end

  options.on('-RFLOAT', '--rf-gain=FLOAT', '<Optional - RF Gain 0.0-16.0(Defaults to 0.0)>') do |r|
    opts[:rf_gain] = r
  end

  options.on('-IFLOAT', '--intermediate-gain=FLOAT', '<Optional - Intermediate Gain 0.0-40.0 (Defaults to 32.0)>') do |i|
    opts[:intermediate_gain] = i
  end

  options.on('-BFLOAT', '--baseband-gain=FLOAT', '<Optional - Baseband Gain 0.0-62.0 (Defaults to 10.0)>') do |b|
    opts[:baseband_gain] = b
  end

  options.on('-k', '--keep-looping', '<Optional - Keep looping over the scan range indefinitely until CTRL+C is caught (Defaults to false)>') do |k|
    opts[:keep_looping] = k
  end

  options.on('-LFILE', '--scan-log=FILE', '<Optional - Path to log scan results to (Defaults to /tmp/pwn_sdr_gqrx_scan_<start_freq>-<target_freq>_<timestamp>.json)>') do |l|
    opts[:scan_log] = l
  end

  options.on('-wLOC', '--location=LOC', '<Optional - Location string to include in AI analysis (e.g. "New York, NY", 90210, GPS coords, etc.)>') do |l|
    opts[:location] = l
  end
end.parse!

begin
  pwn_provider = 'ruby-gem'
  pwn_provider = ENV.fetch('PWN_PROVIDER') if ENV.keys.any? { |s| s == 'PWN_PROVIDER' }

  profiles_available = PWN::SDR::FrequencyAllocation.profiles

  list_scan_profiles = opts[:list_scan_profiles]
  if list_scan_profiles
    puts JSON.pretty_generate(profiles_available)
    exit 0
  end

  profile = opts[:profile]
  opts.merge!(profiles_available[profile.to_sym]) unless profile.nil?

  start_freq = opts[:start_freq]
  start_freq = start_freq.to_s.delete('.') unless start_freq.nil?
  start_freq = start_freq.to_i
  raise 'ERROR: Invalid start frequency.' if !start_freq.nil? && start_freq.zero?

  target_freq = opts[:target_freq]
  target_freq = target_freq.to_s.delete('.') unless target_freq.nil?
  target_freq = target_freq.to_i
  raise 'ERROR: --assume-profile || --target-freq is required.' if target_freq.zero? && profile.nil?

  host = opts[:host]
  port = opts[:port]
  gqrx_sock = PWN::SDR::GQRX.connect(target: host, port: port)

  demodulator_mode = opts[:demodulator_mode]
  bandwidth = opts[:bandwidth]

  audio_gain_db = opts[:audio_gain_db]
  audio_gain_db = audio_gain_db.to_f unless audio_gain_db.nil?

  squelch = opts[:squelch]
  squelch = squelch.to_f unless squelch.nil?

  precision = opts[:precision] ||= 5
  precision = precision.to_i
  raise "ERROR: Invalid precision: #{precision}" unless (1..12).include?(precision)

  strength_lock = opts[:strength_lock]
  strength_lock = strength_lock.to_f unless strength_lock.nil?

  rf_gain = opts[:rf_gain]
  rf_gain = rf_gain.to_f unless rf_gain.nil?

  intermediate_gain = opts[:intermediate_gain]
  intermediate_gain = intermediate_gain.to_f unless intermediate_gain.nil?

  baseband_gain = opts[:baseband_gain]
  baseband_gain = baseband_gain.to_f unless baseband_gain.nil?

  keep_looping = opts[:keep_looping]
  scan_log = opts[:scan_log]
  decoder = opts[:decoder]
  location = opts[:location]

  # Merge opts again to ensure we override profile values with CLI values
  PWN::SDR::GQRX.scan_range(
    gqrx_sock: gqrx_sock,
    start_freq: start_freq,
    target_freq: target_freq,
    demodulator_mode: demodulator_mode,
    bandwidth: bandwidth,
    audio_gain_db: audio_gain_db,
    squelch: squelch,
    precision: precision,
    strength_lock: strength_lock,
    rf_gain: rf_gain,
    intermediate_gain: intermediate_gain,
    baseband_gain: baseband_gain,
    keep_looping: keep_looping,
    scan_log: scan_log,
    decoder: decoder,
    location: location
  )
  puts 'Scan Complete.'
rescue StandardError => e
  raise e
rescue Interrupt, SystemExit
  puts "\nCTRL+C detected - goodbye."
ensure
  PWN::SDR::GQRX.disconnect(gqrx_sock: gqrx_sock) unless gqrx_sock.closed?
end
