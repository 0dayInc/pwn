#!/usr/bin/env ruby
# frozen_string_literal: true

require 'pwn'
require 'optparse'

opts = {}
OptionParser.new do |options|
  options.banner = "USAGE:
    #{$PROGRAM_NAME} [opts]
  "

  options.on('-tTASK_NAME', '--task-name=TASK_NAME', '<Required - Task Name to Start>') do |t|
    opts[:task_name] = t
  end

  options.on('-sDIR', '--save-report-to-dir=DIR', '<Required - Directory to Save Report>') do |d|
    opts[:report_dir] = d
  end

  options.on('-uUSERNAME', '--username=USERNAME', '<Required - Username to AuthN>') do |u|
    opts[:username] = u
  end

  options.on('-pPASSWORD', '--password=PASSWORD', '<Optional - Password to AuthN (Will Prompt if nil)>') do |p|
    opts[:password] = p
  end
end.parse!

if opts.empty?
  puts `#{$PROGRAM_NAME} --help`
  exit 1
end

task_name = opts[:task_name]

report_dir = opts[:report_dir].to_s.scrub
raise "#{report_dir} Does Not Exist." unless Dir.exist?(
  report_dir
)

username = opts[:username]
password = if opts[:password].nil?
             PWN::Plugins::AuthenticationHelper.mask_password
           else
             opts[:password].to_s.scrub
           end

begin
  start_time = Time.now
  puts "Started: #{start_time}"
  PWN::Plugins::OpenVAS.start_task(
    task_name: task_name,
    username: username,
    password: password
  )

  loop do
    if PWN::Plugins::OpenVAS.get_task_status(
      task_name: task_name,
      username: username,
      password: password
    ).downcase == 'done'

      end_time = Time.now
      puts "\nCompleted: #{end_time}"
      break
    end

    print '.'
    sleep 30
  end

  end_time = Time.now
  duration_mins = format(
    '%0.2f',
    (end_time - start_time) / 60
  )

  last_report_id = PWN::Plugins::OpenVAS.last_report_id(
    task_name: task_name,
    username: username,
    password: password
  )
  puts "\nLast Report ID Generated by #{task_name}: #{last_report_id}"

  print "Saving report in #{report_dir}..."
  PWN::Plugins::OpenVAS.save_report(
    report_type: :csv,
    report_id: last_report_id,
    report_dir: report_dir,
    username: username,
    password: password
  )
  puts 'complete.'

  puts "Task Duration (Minutes): #{duration_mins}"
rescue Interrupt
  puts 'CTRL+C detected...goodbye.'
rescue StandardError => e
  raise e
end
